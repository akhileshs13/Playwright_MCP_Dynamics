# Introduction

Playwright Dynamics365 Project  
This project leverages [Playwright](https://playwright.dev/) for end-to-end testing of Dynamics 365 CRM applications, with a modular Page Object Model, environment management, and robust reporting.

---

## Getting Started

This guide will help you set up, configure, and run tests for this project.

---

## Installation & Setup

### 1. Prerequisites

- [Node.js](https://nodejs.org/) (v22.13.1 recommended)
- [VS Code](https://code.visualstudio.com/) (free version)
- [Java JDK](https://adoptopenjdk.net/) (for Allure reporting)

### 2. Install Global Tools

```sh
npm install -g typescript
```

### 3. Set Execution Policy (Windows Only)

Open PowerShell as administrator and run:
```sh
Set-ExecutionPolicy -Scope CurrentUser -ExecutionPolicy Unrestricted
```

### 4. Install Project Dependencies

```sh
npm install
npm init playwright@latest
```

### 5. Install Playwright Browsers

```sh
npx playwright install
```

### 6. Environment Variables

Environment configuration is managed through the `env.test/` directory:
- Store credentials and URLs in environment-specific files
- Use `.env` files for local development
- Environment properties are generated dynamically for reporting

### 7. Configure Storage State

Authentication sessions are managed automatically:
- Login sessions persist via `storageState.json` in `storage-state/`
- Generated by `globals/global-setup.ts` during test initialization
- Reduces login overhead across test runs

### 8. Logging

- Winston is used for centralized logging.
  ```sh
  npm install winston
  ```
- Logger is integrated via `utils/logger.ts`.

---

## TypeScript Configuration

- The project uses a strict [`tsconfig.json`](tsconfig.json) for type safety and modern JavaScript features.
- All source files are included and compiled according to this configuration.
- You can customize TypeScript settings in [`tsconfig.json`](tsconfig.json).

---

## Linting with ESLint

- ESLint is configured for TypeScript using [`eslint.config.mjs`](eslint.config.mjs).
- To check code quality, run:
  ```sh
  npm run lint
  ```
- To automatically fix fixable issues:
  ```sh
  npx eslint . --ext .ts --fix
  ```
- Adjust rules in [`eslint.config.mjs`](eslint.config.mjs) as needed.

---

## Project Structure

```
├── page-objects/
│   ├── components/
│   │   ├── homePage.ts
│   │   ├── loginPage.ts
│   │   └── services/
│   │       └── cases.ts
│   └── pageObjectManager.ts
├── suites/
│   ├── demoTest/
│   │   ├── createNewCases.spec.ts
│   │   ├── editNewCases.spec.ts
│   │   ├── resolveNewCases.spec.ts
│   │   └── regressionFlow.spec.ts
│   └── codegenTest/
│       └── recordedTest.spec.ts
├── fixtures/
│   └── testSetup.ts
├── globals/
│   ├── global-setup.ts
│   └── envNavigator.ts
├── test-data/
│   ├── caseData.json
│   ├── subjectData.json
│   └── generateData/
│       └── createCase.json
├── utils/
│   ├── helper.ts
│   ├── logger.ts
│   ├── autoPopupCloser.ts
│   └── retry-helper.ts
├── env.test/
│   └── environment.properties
├── storage-state/
│   └── storageState.json
├── scripts/
│   ├── generateEnvironmentProperties.ts
│   └── runRegressionAll.ps1
├── allure-results/
├── allure-report/
├── playwright.config.ts
├── tsconfig.json
├── eslint.config.mjs
└── README.md
```

---

## Running Tests

### CLI Commands

**Basic Test Execution:**
- Run all tests:
  ```sh
  npm run test
  ```
- Run demo test suite:
  ```sh
  npm run test:demo
  ```
- Run tagged demo tests:
  ```sh
  npm run test:cases
  ```

**Individual Demo Tests:**
- Create new cases:
  ```sh
  npm run test:demo:create
  ```
- Edit existing cases:
  ```sh
  npm run test:demo:edit
  ```
- Resolve cases:
  ```sh
  npm run test:demo:resolve
  ```

**Sequential Test Execution:**
- Run complete demo flow (create → edit → resolve):
  ```sh
  npm run test:demo:sequential
  ```

**Code Generation & Testing:**
- Generate new test code:
  ```sh
  npm run generate:codegen
  ```
- Run recorded tests:
  ```sh
  npm run test:codegen
  ```

### Advanced Test Options

**Running Specific Test Files:**
```sh
npx playwright test suites/demoTest/createNewCases.spec.ts
npx playwright test suites/demoTest/editNewCases.spec.ts
npx playwright test suites/demoTest/resolveNewCases.spec.ts
```

**Running Tests with Environment Variables:**
```sh
cross-env ENV_FILE=.env TARGET_ENV=LOCAL npx playwright test
```

### Running Tests on Multiple Browsers

- The project is configured to run tests on multiple browsers (Chromium, Firefox, WebKit, Edge).
- To enable or disable browsers, edit the `projects` array in [`playwright.config.ts`](playwright.config.ts):

  ```ts
  projects: [
    { name: 'chromium', use: { browserName: 'chromium' } },
    { name: 'firefox', use: { browserName: 'firefox' } },
    { name: 'webkit', use: { browserName: 'webkit' } },
    { name: 'edge', use: { browserName: 'chromium', channel: 'msedge' } }
  ]
  ```

- By default, Chromium is enabled. Uncomment or add other browsers as needed.

- To run tests on all configured browsers:
  ```sh
  npx playwright test
  ```

---

## Allure Reporting

Allure is used for comprehensive test reporting with dynamic configuration.

**Installation:**
```sh
npm install -D allure-playwright
npm install -g allure-commandline --save-dev
```

**Report Generation Commands:**
- Generate and open complete report:
  ```sh
  npm run test:allureReport
  ```
- Generate report only:
  ```sh
  npm run allure:generate
  ```
- Serve report with auto-browser open:
  ```sh
  npm run allure:serve
  ```
- Open existing report:
  ```sh
  npm run allure:open
  ```

**Dynamic Report Features:**
- Environment properties are generated dynamically before the report
- Real-time configuration values (browser, environment, framework)
- Report name is set dynamically from environment.properties
- Historical trend data preservation

**What happens with `npm run test:allureReport`:**
1. `scripts/generateEnvironmentProperties.ts` creates/updates `env.test/environment.properties`
2. Historical data is preserved from previous reports
3. Allure report is generated with dynamic naming
4. Report opens automatically in your default browser

---

## Utilities & Advanced Features

**Core Utilities:**
- **Helper Utilities (`utils/helper.ts`):**  
  Common waits, random data generation, UI helpers, and async timeout management
- **Retry Helper (`utils/retry-helper.ts`):**  
  Robust retry mechanisms for flaky UI interactions
- **Logger (`utils/logger.ts`):**  
  Centralized Winston-based logging with configurable levels
- **Auto Popup Closer (`utils/autoPopupCloser.ts`):**  
  Automatically closes AI suggestions, popups, and form fill assistants

**Architecture Components:**
- **Page Object Model (`page-objects/`):**  
  Encapsulates UI actions and selectors for maintainability
- **Test Fixtures (`fixtures/testSetup.ts`):**  
  Provides reusable test context and page object instances
- **Global Setup (`globals/global-setup.ts`):**  
  Handles authentication and storage state for all tests
- **Environment Navigator (`globals/envNavigator.ts`):**  
  Manages environment-specific navigation and configuration

**Data Management:**
- **Dynamic Test Data (`test-data/`):**  
  JSON-based test data that updates at runtime
- **Case Data Generation (`test-data/generateData/`):**  
  Automatically tracks created cases for editing and resolution tests
- **Subject Configuration (`test-data/subjectData.json`):**  
  Configurable subject types for different test scenarios

**Enhanced Features:**
- **AI Popup Handling:** Comprehensive detection and dismissal of Copilot and form fill suggestions
- **Sequential Test Support:** Create → Edit → Resolve workflow with shared data
- **Multi-Selector Strategies:** Robust element detection with fallback approaches
- **Environment-Based Configuration:** Support for multiple Dynamics 365 environments

---

## Software Dependencies

**Core Framework:**
- Node.js (v22.13.1 recommended)
- Playwright (@playwright/test ^1.52.0)
- TypeScript (with strict configuration)

**Testing & Reporting:**
- allure-playwright (^3.2.2)
- allure-commandline (^2.34.0)
- winston (logging framework)

**Development Tools:**
- ESLint (^9.30.1) with TypeScript support
- typescript-eslint (^8.36.0)
- ts-node (^10.9.2)

**Utilities:**
- dotenv (^16.4.7) - Environment variable management
- cross-env (^7.0.3) - Cross-platform environment variables
- rimraf (^6.0.1) - Directory cleanup
- chrome-launcher (^1.2.0) - Browser management

**Test Data & Network:**
- playwright-network-cache (^0.2.2) - Network request caching
- node-schedule (^2.1.1) - Task scheduling
- open (^10.1.2) - Cross-platform file/URL opening

---

## Code Generation with Playwright Codegen

- Use Playwright's codegen to quickly generate test flows and selectors:
  ```sh
  npm run generate:codegen
  ```
- Refactor generated code into page objects and helper methods for maintainability.

---

## Latest Releases

Refer to the project repository or release notes for the latest updates.